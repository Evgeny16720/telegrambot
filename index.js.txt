const express = require('express');
const app = express();
app.use(express.json());

const BOT_TOKEN = '8406574277:AAFwnvVsTRl7sNx2pTqDr7I4O-aVPf-pHnw';

app.get('/', (req, res) => {
  console.log('GET / - Bot status requested');
  res.json({
    status: 'âœ… Green Family Group Bot Running',
    timestamp: new Date().toISOString(),
    version: '2.0.0'
  });
});

app.post('/webhook', async (req, res) => {
  try {
    console.log('ðŸ“¨ Webhook received:', JSON.stringify(req.body));
    
    const message = req.body?.message;
    if (!message) {
      console.log('No message');
      return res.status(200).send('OK');
    }
    
    const chatId = message.chat.id;
    const chatType = message.chat.type; // 'private', 'group', 'supergroup'
    const text = message.text || '';
    const username = message.from?.username || message.from?.first_name || 'User';
    
    console.log(`Message from ${username} in ${chatType} (${chatId}): "${text}"`);
    
    let responseText = '';
    
    // Ð’ Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ñ… Ð±Ð¾Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð¸Ð»Ð¸ ÑƒÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ
    if (text === '/start' || text === '/start@bazaznaniygfbot') {
      responseText = `ðŸŒ¿ ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð¯ Green Family Bot!
      
ðŸ‘¥ Ð Ð°Ð±Ð¾Ñ‚Ð°ÑŽ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ðµ: ${message.chat.title || 'Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ'}
ðŸ¤– Ð“Ð¾Ñ‚Ð¾Ð² Ð¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ°Ð¼!
ðŸ“± Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹: /help /ping /info`;

    } else if (text === '/help' || text === '/help@bazaznaniygfbot') {
      responseText = `ðŸ¤– ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Green Family Bot:

/start - ÐŸÑ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ
/help - Ð­Ñ‚Ð° ÑÐ¿Ñ€Ð°Ð²ÐºÐ°
/ping - ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹
/info - Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ¿Ð¿Ðµ
/about - Ðž ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸ Green Family

ðŸ’¡ Ð¢Ð°ÐºÐ¶Ðµ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ñ‚ÑŒÑÑ: "Ð‘Ð¾Ñ‚, [Ð²Ð¾Ð¿Ñ€Ð¾Ñ]"`;

    } else if (text === '/ping' || text === '/ping@bazaznaniygfbot') {
      responseText = `ðŸ“ ÐŸÐ¾Ð½Ð³! 
      
âœ… Ð‘Ð¾Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾
ðŸ•’ Ð’Ñ€ÐµÐ¼Ñ: ${new Date().toLocaleTimeString('ru-RU')}
ðŸ‘¥ Ð’ Ð³Ñ€ÑƒÐ¿Ð¿Ðµ: ${message.chat.title}`;

    } else if (text === '/info' || text === '/info@bazaznaniygfbot') {
      responseText = `ðŸ“Š Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ¿Ð¿Ðµ:
      
ðŸ“ ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ: ${message.chat.title}
ðŸ†” ID: ${chatId}
ðŸ‘¥ Ð¢Ð¸Ð¿: ${chatType}
ðŸ“… Ð’Ñ€ÐµÐ¼Ñ: ${new Date().toLocaleString('ru-RU')}`;

    } else if (text === '/about' || text === '/about@bazaznaniygfbot') {
      responseText = `ðŸŒ¿ Green Family - ÑÐºÐ¾Ð»Ð¾Ð³Ð¸Ñ‡Ð½Ñ‹Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð¶Ð¸Ð·Ð½Ð¸
      
ðŸ  ÐÐ°Ñ‚ÑƒÑ€Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹ Ð´Ð»Ñ Ð´Ð¾Ð¼Ð° Ð¸ ÑÐµÐ¼ÑŒÐ¸
â™»ï¸ Ð—Ð°Ð±Ð¾Ñ‚Ð° Ð¾Ð± ÑÐºÐ¾Ð»Ð¾Ð³Ð¸Ð¸ Ð¸ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ
ðŸ’š ÐšÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼ÐµÐ½ÐµÐ¼`;

    // ÐžÑ‚Ð²ÐµÑ‡Ð°ÐµÐ¼ Ð½Ð° ÑƒÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ "Ð‘Ð¾Ñ‚, ..."
    } else if (text.toLowerCase().startsWith('Ð±Ð¾Ñ‚,') || text.toLowerCase().startsWith('bot,')) {
      const question = text.slice(4).trim();
      responseText = `ðŸ¤– Ð’Ñ‹ ÑÐ¿Ñ€Ð¾ÑÐ¸Ð»Ð¸: "${question}"
      
Ð¯ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð±Ð¾Ñ‚ Green Family. 
Ð”Ð»Ñ Ð¿Ð¾Ð»Ð½Ð¾Ñ†ÐµÐ½Ð½Ð¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð²Ñ‹ÑˆÐµ! ðŸ˜Š`;

    // Ð’ Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ñ… ÐÐ• Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÐ¼ Ð½Ð° Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ (Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ ÑÐ¿Ð°Ð¼Ð¸Ñ‚ÑŒ)
    } else if (chatType === 'private' && text) {
      // Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð² Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ñ… Ñ‡Ð°Ñ‚Ð°Ñ… Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÐ¼ Ð½Ð° Ð²ÑÑ‘
      responseText = `Ð’Ñ‹ Ð½Ð°Ð¿Ð¸ÑÐ°Ð»Ð¸: "${text}"
      
ðŸ¤– Ð¯ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð±Ð¾Ñ‚ Green Family!
Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ /help Ð´Ð»Ñ ÑÐ¿Ð¸ÑÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´.`;
    }
    
    if (responseText) {
      await sendMessage(chatId, responseText);
      console.log('âœ… Response sent');
    } else {
      console.log('â„¹ï¸ No response needed (group message without command)');
    }
    
    return res.status(200).send('OK');
    
  } catch (error) {
    console.error('âŒ Webhook error:', error);
    return res.status(200).send('OK');
  }
});

async function sendMessage(chatId, text) {
  try {
    const fetch = (await import('node-fetch')).default;
    
    const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: chatId,
        text: text,
        parse_mode: 'HTML'
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    console.log('Message sent successfully');
    
  } catch (error) {
    console.error('Send message error:', error);
    throw error;
  }
}

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`ðŸš€ Green Family Group Bot running on port ${PORT}`);
  console.log(`ðŸ“… Started: ${new Date().toISOString()}`);
});

module.exports = app;
