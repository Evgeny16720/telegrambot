const express = require('express');
const app = express();
app.use(express.json({ limit: '10mb' }));

const BOT_TOKEN = '8406574277:AAFwnvVsTRl7sNx2pTqDr7I4O-aVPf-pHnw';

// Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°
app.get('/', (req, res) => {
  console.log('âœ… GET request received');
  res.json({
    status: 'Green Family Bot is WORKING',
    timestamp: new Date().toISOString(),
    version: '3.0'
  });
});

// Webhook
app.post('/webhook', async (req, res) => {
  console.log('ğŸ”¥ WEBHOOK RECEIVED!', new Date().toISOString());
  console.log('ğŸ“Š Body:', JSON.stringify(req.body, null, 2));
  
  try {
    const message = req.body?.message;
    if (!message) {
      console.log('âŒ No message found');
      return res.status(200).send('OK - no message');
    }
    
    const chatId = message.chat.id;
    const text = message.text || '';
    const username = message.from?.username || message.from?.first_name || 'User';
    
    console.log(`ğŸ‘¤ FROM: ${username}, CHAT: ${chatId}, TEXT: "${text}"`);
    
    // ĞŸÑ€Ğ¾ÑÑ‚Ñ‹Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹ Ğ½Ğ° Ğ²ÑĞµ
    let responseText = '';
    
    if (text.includes('/start')) {
      responseText = 'ğŸš€ Ğ‘ĞĞ¢ Ğ ĞĞ‘ĞĞ¢ĞĞ•Ğ¢!\n\nâœ… Webhook Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½\nğŸ“± Vercel Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½\nğŸ‰ Ğ’ÑĞµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ğ² Ğ½Ğ¾Ñ€Ğ¼Ğµ!';
    } else if (text.includes('/help')) {
      responseText = 'ğŸ¤– ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:\n/start - Ñ‚ĞµÑÑ‚\n/help - Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒ\n\nĞ›ÑĞ±Ğ¾Ğ¹ Ñ‚ĞµĞºÑÑ‚ - ÑÑ…Ğ¾ Ğ¾Ñ‚Ğ²ĞµÑ‚';
    } else if (text) {
      responseText = `âœ… ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾: "${text}"\n\nğŸ¤– Ğ‘Ğ¾Ñ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚!\nğŸ• ${new Date().toLocaleTimeString()}`;
    } else {
      responseText = 'ğŸ¤– ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸.';
    }
    
    console.log('ğŸ“¤ SENDING RESPONSE:', responseText.slice(0, 50) + '...');
    
    // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚
    await sendTelegramMessage(chatId, responseText);
    
    console.log('âœ… RESPONSE SENT SUCCESSFULLY!');
    return res.status(200).send('OK');
    
  } catch (error) {
    console.error('ğŸ’¥ CRITICAL ERROR:', error);
    console.error('Stack:', error.stack);
    return res.status(200).send('OK'); // Ğ’ÑĞµĞ³Ğ´Ğ° 200 Ğ´Ğ»Ñ Telegram
  }
});

// ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ² Telegram
async function sendTelegramMessage(chatId, text) {
  try {
    console.log(`ğŸ“ Calling Telegram API for chat ${chatId}...`);
    
    const fetch = (await import('node-fetch')).default;
    
    const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
    const payload = {
      chat_id: chatId,
      text: text,
      parse_mode: 'HTML'
    };
    
    console.log('ğŸ“¡ Telegram URL:', url);
    console.log('ğŸ“¦ Payload:', JSON.stringify(payload));
    
    const response = await fetch(url, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'User-Agent': 'GreenFamilyBot/1.0'
      },
      body: JSON.stringify(payload),
      timeout: 30000
    });
    
    const responseText = await response.text();
    
    console.log('ğŸ“ˆ Telegram Response Status:', response.status);
    console.log('ğŸ“„ Telegram Response Body:', responseText);
    
    if (!response.ok) {
      throw new Error(`Telegram API Error ${response.status}: ${responseText}`);
    }
    
    const data = JSON.parse(responseText);
    if (!data.ok) {
      throw new Error(`Telegram Error: ${data.description}`);
    }
    
    console.log('âœ… Message sent to Telegram successfully!');
    return data;
    
  } catch (error) {
    console.error('ğŸ’¥ Telegram send error:', error);
    throw error;
  }
}

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
process.on('uncaughtException', (error) => {
  console.error('ğŸ’¥ Uncaught Exception:', error);
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('ğŸ’¥ Unhandled Rejection:', reason);
});

// Ğ—Ğ°Ğ¿ÑƒÑĞº
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`ğŸš€ Green Family Bot server STARTED on port ${PORT}`);
  console.log(`ğŸ“… Time: ${new Date().toISOString()}`);
  console.log(`ğŸŒ Environment: ${process.env.NODE_ENV || 'development'}`);
});

module.exports = app;
