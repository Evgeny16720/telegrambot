const express = require('express');
const app = express();
app.use(express.json());

const BOT_TOKEN = '8406574277:AAFwnvVsTRl7sNx2pTqDr7I4O-aVPf-pHnw';

app.get('/', (req, res) => {
  console.log('GET request received');
  res.json({
    status: 'Simple Telegram Bot Running',
    timestamp: new Date().toISOString(),
    version: '1.0.0'
  });
});

app.post('/webhook', async (req, res) => {
  try {
    console.log('Webhook received:', JSON.stringify(req.body));
    
    const message = req.body?.message;
    if (!message) {
      console.log('No message');
      return res.status(200).send('OK');
    }
    
    const chatId = message.chat.id;
    const text = message.text || '';
    const username = message.from?.username || message.from?.first_name || 'User';
    
    console.log(`Message from ${username}: "${text}"`);
    
    let responseText = '';
    
    if (text === '/start') {
      responseText = 'ðŸš€ ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ð±Ð¾Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!\n\nâœ… Vercel Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½\nðŸ“± Ð“Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ!';
    } else if (text === '/help') {
      responseText = 'ðŸ¤– ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹:\n/start - ÐŸÑ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ\n/help - ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ\n/ping - ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°';
    } else if (text === '/ping') {
      responseText = 'ðŸ“ ÐŸÐ¾Ð½Ð³! Ð‘Ð¾Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾.';
    } else if (text) {
      responseText = `Ð’Ñ‹ Ð½Ð°Ð¿Ð¸ÑÐ°Ð»Ð¸: "${text}"\n\nðŸ¤– ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ ÑÑ…Ð¾-Ð±Ð¾Ñ‚ Ð² Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¸!`;
    }
    
    if (responseText) {
      await sendMessage(chatId, responseText);
      console.log('Response sent');
    }
    
    return res.status(200).send('OK');
    
  } catch (error) {
    console.error('Webhook error:', error);
    return res.status(200).send('OK');
  }
});

async function sendMessage(chatId, text) {
  try {
    const fetch = (await import('node-fetch')).default;
    
    const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: chatId,
        text: text
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    console.log('Message sent successfully');
    
  } catch (error) {
    console.error('Send message error:', error);
    throw error;
  }
}

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Bot server running on port ${PORT}`);
  console.log(`Started: ${new Date().toISOString()}`);
});

module.exports = app;
