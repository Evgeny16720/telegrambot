const express = require('express');
const app = express();
app.use(express.json());

const BOT_TOKEN = '8406574277:AAFwnvVsTRl7sNx2pTqDr7I4O-aVPf-pHnw';

// Главная страница
app.get('/', (req, res) => {
  console.log('GET / - Bot status requested');
  res.json({
    status: '✅ Simple Telegram Bot Running',
    timestamp: new Date().toISOString(),
    version: '1.0.0'
  });
});

// Webhook
app.post('/webhook', async (req, res) => {
  try {
    console.log('📨 Webhook received:', JSON.stringify(req.body));
    
    const message = req.body?.message;
    if (!message) {
      console.log('No message');
      return res.status(200).send('OK - no message');
    }
    
    const chatId = message.chat.id;
    const text = message.text || '';
    const username = message.from?.username || message.from?.first_name || 'User';
    
    console.log(`Message from ${username}: "${text}"`);
    
    let responseText = '';
    
    if (text === '/start') {
      responseText = '🚀 Простой бот работает!\n\n✅ Vercel подключен\n📱 Готов к работе!';
    } else if (text === '/help') {
      responseText = '🤖 Команды:\n/start - Приветствие\n/help - Помощь\n/ping - Проверка';
    } else if (text === '/ping') {
      responseText = '🏓 Понг! Бот работает нормально.';
    } else if (text) {
      responseText = `Вы написали: "${text}"\n\n🤖 Простой эхо-бот в действии!`;
    }
    
    if (responseText) {
      await sendMessage(chatId, responseText);
      console.log('✅ Response sent');
    }
    
    return res.status(200).send('OK');
    
  } catch (error) {
    console.error('❌ Webhook error:', error);
    return res.status(200).send('OK');
  }
});

// Отправка сообщения
async function sendMessage(chatId, text) {
  try {
    const fetch = (await import('node-fetch')).default;
    
    const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: chatId,
        text: text
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    console.log('Message sent successfully');
    
  } catch (error) {
    console.error('Send message error:', error);
    throw error;
  }
}

// Запуск сервера
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`🚀 Simple Bot server running on port ${PORT}`);
  console.log(`📅 Started: ${new Date().toISOString()}`);
});

module.exports = app;
